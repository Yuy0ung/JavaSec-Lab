<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传执行演示 - Java Security Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <style>
        .vulnerability-demo { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .safe-demo { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .payload-box { background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; }
        .result-box { min-height: 150px; border: 1px solid #dee2e6; padding: 10px; background-color: #f8f9fa; font-family: monospace; white-space: pre-wrap; }
        .file-content { font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Java Security Lab</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/rce">RCE主页</a>
                <a class="nav-link" href="/">返回首页</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">文件上传执行演示</h1>
                
                <!-- 说明部分 -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> 文件上传执行漏洞</h5>
                    <p>文件上传执行漏洞是指攻击者能够上传恶意文件并在服务器上执行的安全漏洞。这种漏洞通常发生在应用程序没有正确验证上传文件的类型、内容或执行权限时。</p>
                    <p><strong>常见场景：</strong> 头像上传、文档上传、插件安装、模板上传等</p>
                    <p><strong>危害：</strong> 远程代码执行、服务器控制、数据泄露、系统破坏</p>
                </div>

                <!-- 恶意文件示例 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>恶意文件示例</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Shell脚本 (.sh)：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <pre class="file-content">#!/bin/bash
echo "System Information:"
whoami
id
pwd
ls -la</pre>
                                </div>
                                
                                <h6>Python脚本 (.py)：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <pre class="file-content">import os
import subprocess

print("Python RCE Demo")
result = subprocess.run(['whoami'], capture_output=True, text=True)
print(f"Current user: {result.stdout}")</pre>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Java类文件内容：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <pre class="file-content">public class Exploit {
    public static void main(String[] args) {
        try {
            Runtime.getRuntime().exec("whoami");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}</pre>
                                </div>
                                
                                <h6>批处理文件 (.bat)：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <pre class="file-content">@echo off
echo Windows RCE Demo
whoami
dir
ipconfig</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 演示区域 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card vulnerability-demo mb-4">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 漏洞演示 - 任意文件上传执行</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-danger"><strong>危险：</strong> 允许上传并执行任意文件</p>
                                
                                <form id="unsafeUploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="unsafeFile" class="form-label">选择文件：</label>
                                        <input type="file" class="form-control" id="unsafeFile" name="file">
                                        <div class="form-text">支持任意文件类型上传</div>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-danger" onclick="uploadUnsafe()">
                                            <i class="fas fa-upload"></i> 上传并执行（危险）
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearUnsafeResult()">
                                            清除结果
                                        </button>
                                    </div>
                                </form>
                                
                                <div class="mb-3">
                                    <h6>快速测试文件：</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-danger btn-sm" onclick="createTestFile('shell', 'test.sh')">
                                            创建Shell脚本
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="createTestFile('python', 'test.py')">
                                            创建Python脚本
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="createTestFile('java', 'Test.java')">
                                            创建Java文件
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="createTestFile('batch', 'test.bat')">
                                            创建批处理文件
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>执行结果：</h6>
                                    <div id="unsafeResult" class="result-box">
                                        选择文件并点击"上传并执行"查看结果...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card safe-demo mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-shield-alt"></i> 安全版本 - 文件类型限制</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-success"><strong>安全：</strong> 严格的文件类型和内容验证</p>
                                
                                <form id="safeUploadForm" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="safeFile" class="form-label">选择文件：</label>
                                        <input type="file" class="form-control" id="safeFile" name="file" accept=".txt,.log,.md">
                                        <div class="form-text">只允许: .txt, .log, .md 文件</div>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-success" onclick="uploadSafe()">
                                            <i class="fas fa-shield-alt"></i> 安全上传
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearSafeResult()">
                                            清除结果
                                        </button>
                                    </div>
                                </form>
                                
                                <div class="mb-3">
                                    <h6>允许的文件类型：</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-success btn-sm" onclick="createSafeFile('text', 'safe.txt')">
                                            创建文本文件
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="createSafeFile('log', 'app.log')">
                                            创建日志文件
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="createSafeFile('markdown', 'readme.md')">
                                            创建Markdown文件
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="createTestFile('shell', 'malicious.sh')">
                                            测试恶意文件
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>处理结果：</h6>
                                    <div id="safeResult" class="result-box">
                                        选择文件并点击"安全上传"查看结果...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 代码对比 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>代码实现对比</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-danger">漏洞代码：</h6>
                                <pre><code class="language-java">// 危险：直接执行上传的文件
@PostMapping("/upload/unsafe")
public String uploadUnsafe(@RequestParam("file") MultipartFile file) {
    try {
        String filename = file.getOriginalFilename();
        File uploadFile = new File("/tmp/" + filename);
        file.transferTo(uploadFile);
        
        // 直接执行文件
        Process process = Runtime.getRuntime()
            .exec("chmod +x " + uploadFile.getAbsolutePath());
        process = Runtime.getRuntime()
            .exec(uploadFile.getAbsolutePath());
        
        return readOutput(process);
    } catch (Exception e) {
        return "Error: " + e.getMessage();
    }
}</code></pre>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">安全代码：</h6>
                                <pre><code class="language-java">// 安全：严格的文件验证
@PostMapping("/upload/safe")
public String uploadSafe(@RequestParam("file") MultipartFile file) {
    // 文件类型白名单
    List&lt;String&gt; allowedTypes = Arrays.asList("txt", "log", "md");
    
    String filename = file.getOriginalFilename();
    String extension = getFileExtension(filename);
    
    if (!allowedTypes.contains(extension.toLowerCase())) {
        return "File type not allowed";
    }
    
    // 文件大小限制
    if (file.getSize() > 1024 * 1024) { // 1MB
        return "File too large";
    }
    
    // 内容验证
    if (!isValidContent(file)) {
        return "Invalid file content";
    }
    
    // 安全存储，不执行
    return saveFileSecurely(file);
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 绕过技巧 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>文件上传绕过技巧</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>文件名绕过：</h6>
                                <ul>
                                    <li><code>shell.php.jpg</code> - 双扩展名</li>
                                    <li><code>shell.php%00.jpg</code> - 空字节绕过</li>
                                    <li><code>shell.php.</code> - 点号绕过</li>
                                    <li><code>shell.php::$DATA</code> - NTFS流</li>
                                    <li><code>shell.pHp</code> - 大小写绕过</li>
                                </ul>
                                
                                <h6>MIME类型绕过：</h6>
                                <ul>
                                    <li>修改Content-Type头</li>
                                    <li>使用图片MIME类型</li>
                                    <li>多部分上传绕过</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>文件内容绕过：</h6>
                                <ul>
                                    <li>文件头伪造（魔术字节）</li>
                                    <li>图片马（在图片中嵌入代码）</li>
                                    <li>压缩包上传</li>
                                    <li>符号链接攻击</li>
                                </ul>
                                
                                <h6>服务器配置绕过：</h6>
                                <ul>
                                    <li>.htaccess文件上传</li>
                                    <li>web.config文件上传</li>
                                    <li>目录遍历攻击</li>
                                    <li>竞争条件攻击</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 防护建议 -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-shield-alt"></i> 文件上传安全防护</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>文件验证：</h6>
                            <ul>
                                <li>白名单扩展名验证</li>
                                <li>MIME类型检查</li>
                                <li>文件头验证</li>
                                <li>文件大小限制</li>
                                <li>文件名长度限制</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>存储安全：</h6>
                            <ul>
                                <li>存储在非Web目录</li>
                                <li>重命名上传文件</li>
                                <li>设置正确的文件权限</li>
                                <li>使用专门的文件服务器</li>
                                <li>病毒扫描</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 检测方法 -->
                <div class="alert alert-warning">
                    <h5><i class="fas fa-search"></i> 文件上传漏洞检测</h5>
                    <ul class="mb-0">
                        <li><strong>黑盒测试：</strong> 尝试上传各种恶意文件类型</li>
                        <li><strong>绕过测试：</strong> 测试各种绕过技巧</li>
                        <li><strong>路径遍历：</strong> 测试目录遍历攻击</li>
                        <li><strong>文件包含：</strong> 结合文件包含漏洞测试</li>
                        <li><strong>代码审计：</strong> 检查文件处理相关代码</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        // 文件内容模板
        const fileTemplates = {
            shell: `#!/bin/bash
echo "Shell Script RCE Demo"
echo "Current user: $(whoami)"
echo "Current directory: $(pwd)"
echo "System info: $(uname -a)"
ls -la`,
            python: `#!/usr/bin/env python3
import os
import subprocess
import platform

print("Python RCE Demo")
print(f"Current user: {os.getenv('USER', 'unknown')}")
print(f"Current directory: {os.getcwd()}")
print(f"Platform: {platform.system()}")

try:
    result = subprocess.run(['whoami'], capture_output=True, text=True)
    print(f"Whoami result: {result.stdout.strip()}")
except Exception as e:
    print(f"Error: {e}")`,
            java: `public class Test {
    public static void main(String[] args) {
        System.out.println("Java RCE Demo");
        try {
            Process process = Runtime.getRuntime().exec("whoami");
            java.io.BufferedReader reader = new java.io.BufferedReader(
                new java.io.InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println("Current user: " + line);
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}`,
            batch: `@echo off
echo Windows Batch RCE Demo
echo Current user: %USERNAME%
echo Current directory: %CD%
echo Computer name: %COMPUTERNAME%
whoami
dir`,
            text: `This is a safe text file.
It contains only plain text content.
No executable code here.`,
            log: `[2024-01-01 12:00:00] INFO: Application started
[2024-01-01 12:00:01] INFO: User logged in
[2024-01-01 12:00:02] INFO: Processing request
[2024-01-01 12:00:03] INFO: Request completed`,
            markdown: `# Safe Markdown File

This is a safe markdown file with no executable content.

## Features
- Plain text
- Markdown formatting
- No scripts or executable code

## Safety
This file is safe to upload and view.`
        };
        
        // 创建测试文件
        function createTestFile(type, filename) {
            const content = fileTemplates[type];
            const blob = new Blob([content], { type: 'text/plain' });
            const file = new File([blob], filename, { type: 'text/plain' });
            
            // 创建新的文件输入
            const input = document.getElementById('unsafeFile');
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            
            alert(`已创建测试文件: ${filename}`);
        }
        
        // 创建安全文件
        function createSafeFile(type, filename) {
            const content = fileTemplates[type];
            const blob = new Blob([content], { type: 'text/plain' });
            const file = new File([blob], filename, { type: 'text/plain' });
            
            const input = document.getElementById('safeFile');
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            
            alert(`已创建安全文件: ${filename}`);
        }
        
        // 上传不安全文件
        function uploadUnsafe() {
            const fileInput = document.getElementById('unsafeFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const resultDiv = document.getElementById('unsafeResult');
            resultDiv.textContent = '上传并执行中...';
            
            fetch('/rce/upload/unsafe', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let result = `文件名: ${data.filename}\n`;
                result += `文件大小: ${data.fileSize} bytes\n`;
                result += `状态: ${data.success ? '成功' : '失败'}\n\n`;
                
                if (data.output) {
                    result += `执行输出:\n${data.output}\n`;
                }
                
                if (data.error) {
                    result += `错误信息:\n${data.error}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '上传失败: ' + error;
            });
        }
        
        // 上传安全文件
        function uploadSafe() {
            const fileInput = document.getElementById('safeFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            const resultDiv = document.getElementById('safeResult');
            resultDiv.textContent = '安全上传中...';
            
            fetch('/rce/upload/safe', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                let result = `文件名: ${data.filename}\n`;
                result += `文件大小: ${data.fileSize} bytes\n`;
                result += `状态: ${data.success ? '成功' : '失败'}\n`;
                result += `验证结果: ${data.validation}\n\n`;
                
                if (data.content) {
                    result += `文件内容预览:\n${data.content}`;
                }
                
                if (data.error) {
                    result += `错误信息:\n${data.error}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '上传失败: ' + error;
            });
        }
        
        // 清除结果
        function clearUnsafeResult() {
            document.getElementById('unsafeResult').textContent = '选择文件并点击"上传并执行"查看结果...';
        }
        
        function clearSafeResult() {
            document.getElementById('safeResult').textContent = '选择文件并点击"安全上传"查看结果...';
        }
    </script>
</body>
</html>