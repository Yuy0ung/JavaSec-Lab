<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL参数XSS演示 - Java Security Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <style>
        .vulnerability-demo { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .safe-demo { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .payload-box { background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; }
        .result-box { min-height: 100px; border: 1px solid #dee2e6; padding: 10px; background-color: #f8f9fa; }
        .url-example { background-color: #e9ecef; padding: 10px; border-radius: 5px; font-family: monospace; word-break: break-all; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Java Security Lab</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/xss">XSS主页</a>
                <a class="nav-link" href="/">返回首页</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">URL参数XSS演示</h1>
                
                <!-- 说明部分 -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> 什么是URL参数XSS？</h5>
                    <p>URL参数XSS是指通过URL查询参数传递恶意脚本，当服务器或客户端JavaScript处理这些参数并将其输出到页面时，恶意脚本得以执行。这种攻击常见于搜索功能、页面跳转、错误消息显示等场景。</p>
                    <p><strong>攻击流程：</strong> 构造恶意URL → 诱导用户点击 → 服务器处理参数 → 恶意脚本在页面执行</p>
                </div>

                <!-- 当前URL参数显示 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>当前页面URL参数</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="url-example" id="currentUrl">
                                    <span th:text="${#httpServletRequest.requestURL + '?' + #httpServletRequest.queryString}">当前URL</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary btn-sm" onclick="updateUrlDisplay()">刷新URL显示</button>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6>解析的参数：</h6>
                            <div id="parsedParams" class="result-box">
                                <div th:if="${param.name != null}">
                                    <strong>name:</strong> <span th:text="${param.name}">参数值</span><br>
                                </div>
                                <div th:if="${param.message != null}">
                                    <strong>message:</strong> <span th:text="${param.message}">参数值</span><br>
                                </div>
                                <div th:if="${param.search != null}">
                                    <strong>search:</strong> <span th:text="${param.search}">参数值</span><br>
                                </div>
                                <div th:if="${param.redirect != null}">
                                    <strong>redirect:</strong> <span th:text="${param.redirect}">参数值</span><br>
                                </div>
                                <div th:if="${param.name == null and param.message == null and param.search == null and param.redirect == null}">
                                    无URL参数
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 常见载荷 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>常见URL参数XSS载荷</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>基础载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>?name=&lt;script&gt;alert('XSS')&lt;/script&gt;</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>?message=&lt;img src=x onerror=alert('XSS')&gt;</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>?search=&lt;svg onload=alert(document.cookie)&gt;</code>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>编码绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>?name=%3Cscript%3Ealert('XSS')%3C/script%3E</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>?message=javascript:alert('XSS')</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>?redirect=data:text/html,&lt;script&gt;alert('XSS')&lt;/script&gt;</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 演示区域 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card vulnerability-demo mb-4">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 漏洞演示 - 直接输出参数</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-danger"><strong>危险：</strong> 直接将URL参数输出到页面</p>
                                
                                <!-- 服务器端处理的参数显示 -->
                                <div class="mb-3">
                                    <h6>服务器端处理结果：</h6>
                                    <div class="result-box">
                                        <div th:if="${param.name != null}">
                                            欢迎用户：<span th:utext="${param.name}">用户名</span>
                                        </div>
                                        <div th:if="${param.message != null}">
                                            消息内容：<span th:utext="${param.message}">消息</span>
                                        </div>
                                        <div th:if="${param.search != null}">
                                            搜索关键词：<span th:utext="${param.search}">关键词</span>
                                        </div>
                                        <div th:if="${param.name == null and param.message == null and param.search == null}">
                                            请通过URL参数传递内容进行测试
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 客户端JavaScript处理 -->
                                <div class="mb-3">
                                    <h6>客户端JavaScript处理：</h6>
                                    <button class="btn btn-danger btn-sm" onclick="vulnerableClientProcessing()">
                                        处理URL参数（危险）
                                    </button>
                                    <div id="clientResult" class="result-box mt-2">
                                        JavaScript处理结果将显示在这里...
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>快速测试链接：</h6>
                                    <div class="d-grid gap-2">
                                        <a href="?name=<script>alert('Name XSS!')</script>" class="btn btn-outline-danger btn-sm">
                                            测试name参数XSS
                                        </a>
                                        <a href="?message=<img src=x onerror=alert('Message XSS!')>" class="btn btn-outline-danger btn-sm">
                                            测试message参数XSS
                                        </a>
                                        <a href="?search=<svg onload=alert('Search XSS!')>" class="btn btn-outline-danger btn-sm">
                                            测试search参数XSS
                                        </a>
                                        <a href="?name=<script>document.body.style.backgroundColor='red'</script>" class="btn btn-outline-danger btn-sm">
                                            页面修改测试
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card safe-demo mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-shield-alt"></i> 安全版本 - 参数过滤</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-success"><strong>安全：</strong> 对URL参数进行验证和转义</p>
                                
                                <!-- 安全处理的参数显示 -->
                                <div class="mb-3">
                                    <h6>安全处理结果：</h6>
                                    <div class="result-box">
                                        <div th:if="${param.name != null}">
                                            欢迎用户：<span th:text="${param.name}">用户名</span>
                                        </div>
                                        <div th:if="${param.message != null}">
                                            消息内容：<span th:text="${param.message}">消息</span>
                                        </div>
                                        <div th:if="${param.search != null}">
                                            搜索关键词：<span th:text="${param.search}">关键词</span>
                                        </div>
                                        <div th:if="${param.name == null and param.message == null and param.search == null}">
                                            请通过URL参数传递内容进行测试
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- 安全的客户端处理 -->
                                <div class="mb-3">
                                    <h6>安全的JavaScript处理：</h6>
                                    <button class="btn btn-success btn-sm" onclick="safeClientProcessing()">
                                        安全处理URL参数
                                    </button>
                                    <div id="safeClientResult" class="result-box mt-2">
                                        安全处理结果将显示在这里...
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>安全测试链接：</h6>
                                    <div class="d-grid gap-2">
                                        <a href="?name=正常用户名" class="btn btn-outline-success btn-sm">
                                            正常name参数
                                        </a>
                                        <a href="?message=这是一条正常消息" class="btn btn-outline-success btn-sm">
                                            正常message参数
                                        </a>
                                        <a href="?search=Java安全" class="btn btn-outline-success btn-sm">
                                            正常search参数
                                        </a>
                                        <a href="/xss/url" class="btn btn-outline-secondary btn-sm">
                                            清除所有参数
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL构造工具 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>URL构造工具</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="paramName" class="form-label">参数名：</label>
                                    <select class="form-select" id="paramName">
                                        <option value="name">name</option>
                                        <option value="message">message</option>
                                        <option value="search">search</option>
                                        <option value="redirect">redirect</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="paramValue" class="form-label">参数值：</label>
                                    <input type="text" class="form-control" id="paramValue" 
                                           placeholder="输入参数值...">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">生成的URL：</label>
                                    <div id="generatedUrl" class="url-example">
                                        URL将在这里显示...
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>操作：</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="generateUrl()">
                                        生成URL
                                    </button>
                                    <button class="btn btn-success btn-sm" onclick="visitGeneratedUrl()">
                                        访问生成的URL
                                    </button>
                                    <button class="btn btn-warning btn-sm" onclick="encodeUrl()">
                                        URL编码
                                    </button>
                                </div>
                                
                                <h6 class="mt-3">快速载荷：</h6>
                                <div class="d-grid gap-1">
                                    <button class="btn btn-outline-danger btn-sm" onclick="setPayload('&lt;script&gt;alert(\'XSS\')&lt;/script&gt;')">
                                        Script标签
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="setPayload('&lt;img src=x onerror=alert(\'XSS\')&gt;')">
                                        Image事件
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="setPayload('&lt;svg onload=alert(\'XSS\')&gt;')">
                                        SVG事件
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="setPayload('正常内容')">
                                        正常内容
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 代码对比 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>代码实现对比</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-danger">漏洞代码：</h6>
                                <pre><code class="language-html"><!-- 服务器端：直接输出 -->
&lt;div th:utext="${param.name}"&gt;&lt;/div&gt;

<!-- 客户端：直接处理 -->
&lt;script&gt;
function processParams() {
    var params = new URLSearchParams(location.search);
    var name = params.get('name');
    document.getElementById('result').innerHTML = name;
}
&lt;/script&gt;</code></pre>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">安全代码：</h6>
                                <pre><code class="language-html"><!-- 服务器端：HTML转义 -->
&lt;div th:text="${param.name}"&gt;&lt;/div&gt;

<!-- 客户端：安全处理 -->
&lt;script&gt;
function safeProcessParams() {
    var params = new URLSearchParams(location.search);
    var name = params.get('name');
    if (isValidInput(name)) {
        document.getElementById('result').textContent = name;
    }
}
&lt;/script&gt;</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 防护建议 -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-shield-alt"></i> URL参数XSS防护建议</h5>
                    <ul class="mb-0">
                        <li><strong>输入验证：</strong> 验证所有URL参数的格式和内容</li>
                        <li><strong>输出编码：</strong> 对输出到HTML的参数进行适当编码</li>
                        <li><strong>白名单过滤：</strong> 只允许预期的参数名和值</li>
                        <li><strong>长度限制：</strong> 限制参数值的最大长度</li>
                        <li><strong>CSP策略：</strong> 实施内容安全策略防止脚本执行</li>
                        <li><strong>URL验证：</strong> 对重定向URL进行严格验证</li>
                    </ul>
                </div>

                <!-- 学习提示 -->
                <div class="alert alert-warning">
                    <h5><i class="fas fa-lightbulb"></i> 检测技巧</h5>
                    <ul class="mb-0">
                        <li><strong>参数枚举：</strong> 测试所有可能的URL参数</li>
                        <li><strong>编码测试：</strong> 尝试不同的编码方式绕过过滤</li>
                        <li><strong>长载荷测试：</strong> 使用超长载荷测试长度限制</li>
                        <li><strong>特殊字符：</strong> 测试各种特殊字符和符号</li>
                        <li><strong>组合攻击：</strong> 结合多个参数进行攻击</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        // 更新URL显示
        function updateUrlDisplay() {
            document.getElementById('currentUrl').textContent = window.location.href;
        }
        
        // 漏洞的客户端处理
        function vulnerableClientProcessing() {
            var params = new URLSearchParams(window.location.search);
            var result = '';
            
            params.forEach(function(value, key) {
                result += key + ': ' + value + '<br>';
            });
            
            if (result === '') {
                result = '无URL参数';
            }
            
            // 危险：直接使用innerHTML
            document.getElementById('clientResult').innerHTML = '客户端处理结果：<br>' + result;
        }
        
        // 安全的客户端处理
        function safeClientProcessing() {
            var params = new URLSearchParams(window.location.search);
            var result = '';
            
            params.forEach(function(value, key) {
                // 安全：进行HTML转义
                var safeKey = escapeHtml(key);
                var safeValue = escapeHtml(value);
                result += safeKey + ': ' + safeValue + '\n';
            });
            
            if (result === '') {
                result = '无URL参数';
            }
            
            // 安全：使用textContent
            document.getElementById('safeClientResult').textContent = '安全处理结果：\n' + result;
        }
        
        // HTML转义函数
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 输入验证函数
        function isValidInput(input) {
            if (!input) return false;
            // 简单验证：不包含HTML标签和JavaScript
            return !/<[^>]*>/g.test(input) && !/javascript:/i.test(input);
        }
        
        // 生成URL
        function generateUrl() {
            var paramName = document.getElementById('paramName').value;
            var paramValue = document.getElementById('paramValue').value;
            
            var baseUrl = window.location.origin + window.location.pathname;
            var generatedUrl = baseUrl + '?' + paramName + '=' + encodeURIComponent(paramValue);
            
            document.getElementById('generatedUrl').textContent = generatedUrl;
        }
        
        // 访问生成的URL
        function visitGeneratedUrl() {
            var url = document.getElementById('generatedUrl').textContent;
            if (url && url !== 'URL将在这里显示...') {
                window.location.href = url;
            } else {
                alert('请先生成URL');
            }
        }
        
        // URL编码
        function encodeUrl() {
            var paramValue = document.getElementById('paramValue').value;
            if (paramValue) {
                document.getElementById('paramValue').value = encodeURIComponent(paramValue);
                generateUrl();
            }
        }
        
        // 设置载荷
        function setPayload(payload) {
            document.getElementById('paramValue').value = payload;
            generateUrl();
        }
        
        // 页面加载时初始化
        window.onload = function() {
            updateUrlDisplay();
            generateUrl();
        };
    </script>
</body>
</html>