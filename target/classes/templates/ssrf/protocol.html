<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>协议利用SSRF攻击演示 - Java Security Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <style>
        .vulnerability-demo { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .safe-demo { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .payload-box { background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; }
        .result-box { min-height: 150px; border: 1px solid #dee2e6; padding: 10px; background-color: #f8f9fa; font-family: monospace; white-space: pre-wrap; }
        .attack-input { font-family: monospace; }
        .protocol-card { border-left: 4px solid #007bff; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Java Security Lab</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/ssrf">SSRF主页</a>
                <a class="nav-link" href="/">返回首页</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">协议利用SSRF攻击演示</h1>
                
                <!-- 说明部分 -->
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle"></i> 协议利用攻击</h5>
                    <p>SSRF攻击不仅限于HTTP协议，攻击者可以利用多种协议进行攻击，如file://、ftp://、gopher://等。</p>
                    <p><strong>攻击目标：</strong> 本地文件系统、内网服务、数据库等</p>
                    <p><strong>危害等级：</strong> 极高 - 可读取敏感文件，操作内网服务</p>
                </div>

                <!-- 协议攻击演示 -->
                <div class="card vulnerability-demo mb-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="fas fa-bomb"></i> 协议利用攻击演示</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="protocolUrl" class="form-label">攻击URL：</label>
                                    <input type="text" class="form-control attack-input" id="protocolUrl" 
                                           placeholder="file:///etc/passwd" value="file:///etc/passwd">
                                </div>
                                
                                <div class="mb-3">
                                    <button type="button" class="btn btn-danger" onclick="executeProtocolAttack()">
                                        <i class="fas fa-bomb"></i> 执行协议攻击
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearProtocolResult()">
                                        清除结果
                                    </button>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>协议攻击载荷：</h6>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-danger btn-sm" onclick="setProtocolUrl('file:///etc/passwd')">
                                            file:// - 读取系统用户文件
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setProtocolUrl('file:///etc/hosts')">
                                            file:// - 读取主机配置
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setProtocolUrl('ftp://127.0.0.1:21')">
                                            ftp:// - FTP服务探测
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setProtocolUrl('dict://127.0.0.1:11211/stats')">
                                            dict:// - Memcached操作
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="setProtocolUrl('gopher://127.0.0.1:6379/_*1%0d%0a$4%0d%0ainfo%0d%0a')">
                                            gopher:// - Redis操作
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>攻击结果：</h6>
                                <div id="protocolResult" class="result-box">
                                    选择协议载荷并点击"执行协议攻击"查看结果...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 协议详细说明 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card protocol-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-file"></i> file:// 协议攻击</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>用途：</strong> 读取本地文件系统</p>
                                <p><strong>危害：</strong> 获取敏感配置文件、密钥等</p>
                                <h6>常见载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>file:///etc/passwd</code> - Linux用户文件
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>file:///etc/shadow</code> - Linux密码文件
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>file:///proc/self/environ</code> - 环境变量
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>file:///var/log/apache2/access.log</code> - 日志文件
                                </div>
                            </div>
                        </div>
                        
                        <div class="card protocol-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-server"></i> ftp:// 协议攻击</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>用途：</strong> FTP服务探测和操作</p>
                                <p><strong>危害：</strong> 内网FTP服务发现，文件上传下载</p>
                                <h6>常见载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>ftp://127.0.0.1:21</code> - 本地FTP探测
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>ftp://192.168.1.100:21</code> - 内网FTP探测
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>ftp://anonymous:@127.0.0.1/</code> - 匿名登录
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card protocol-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-database"></i> dict:// 协议攻击</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>用途：</strong> 字典服务协议，可用于探测服务</p>
                                <p><strong>危害：</strong> 内网服务探测，Memcached等操作</p>
                                <h6>常见载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>dict://127.0.0.1:11211/stats</code> - Memcached状态
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>dict://127.0.0.1:6379/info</code> - Redis信息
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>dict://127.0.0.1:3306/</code> - MySQL探测
                                </div>
                            </div>
                        </div>
                        
                        <div class="card protocol-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-network-wired"></i> gopher:// 协议攻击</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>用途：</strong> 万能协议，可构造任意TCP数据包</p>
                                <p><strong>危害：</strong> 操作Redis、MySQL等内网服务</p>
                                <h6>常见载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>gopher://127.0.0.1:6379/_*1%0d%0a$4%0d%0ainfo%0d%0a</code>
                                    <small class="text-muted d-block">Redis INFO命令</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>gopher://127.0.0.1:6379/_*3%0d%0a$3%0d%0aset%0d%0a$4%0d%0atest%0d%0a$5%0d%0ahello%0d%0a</code>
                                    <small class="text-muted d-block">Redis SET命令</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gopher协议构造工具 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Gopher协议载荷构造工具</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="gopherHost" class="form-label">目标主机：</label>
                                    <input type="text" class="form-control" id="gopherHost" value="127.0.0.1">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="gopherPort" class="form-label">目标端口：</label>
                                    <input type="number" class="form-control" id="gopherPort" value="6379">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="gopherCommand" class="form-label">原始命令：</label>
                                    <textarea class="form-control attack-input" id="gopherCommand" rows="3" 
                                              placeholder="INFO">INFO</textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="gopherProtocol" class="form-label">协议类型：</label>
                                    <select class="form-select" id="gopherProtocol">
                                        <option value="redis">Redis</option>
                                        <option value="mysql">MySQL</option>
                                        <option value="http">HTTP</option>
                                        <option value="custom">自定义</option>
                                    </select>
                                </div>
                                
                                <button type="button" class="btn btn-primary" onclick="generateGopherPayload()">
                                    <i class="fas fa-cogs"></i> 生成Gopher载荷
                                </button>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>生成的Gopher载荷：</h6>
                                <div id="gopherResult" class="result-box">
                                    输入命令并点击"生成Gopher载荷"...
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success btn-sm" onclick="testGopherPayload()">
                                        <i class="fas fa-play"></i> 测试载荷
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="copyGopherPayload()">
                                        <i class="fas fa-copy"></i> 复制载荷
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 代码示例 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>协议处理代码对比</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-danger">漏洞代码：</h6>
                                <pre><code class="language-java">@PostMapping("/protocol")
public String handleProtocol(@RequestParam String url) {
    try {
        // 支持多种协议，存在安全风险
        URL targetUrl = new URL(url);
        URLConnection conn = targetUrl.openConnection();
        
        // 直接读取内容
        InputStream is = conn.getInputStream();
        byte[] buffer = new byte[1024];
        StringBuilder result = new StringBuilder();
        
        int bytesRead;
        while ((bytesRead = is.read(buffer)) != -1) {
            result.append(new String(buffer, 0, bytesRead));
        }
        
        return result.toString();
    } catch (Exception e) {
        return "Error: " + e.getMessage();
    }
}</code></pre>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-success">安全代码：</h6>
                                <pre><code class="language-java">@PostMapping("/safe-protocol")
public String handleSafeProtocol(@RequestParam String url) {
    try {
        URL targetUrl = new URL(url);
        
        // 严格的协议白名单
        String protocol = targetUrl.getProtocol().toLowerCase();
        if (!"http".equals(protocol) && !"https".equals(protocol)) {
            return "Error: 不支持的协议 " + protocol;
        }
        
        // 其他安全检查...
        String host = targetUrl.getHost();
        if (isPrivateIP(host) || isLocalhost(host)) {
            return "Error: 禁止访问内网地址";
        }
        
        // 安全的HTTP请求处理
        HttpURLConnection conn = (HttpURLConnection) 
            targetUrl.openConnection();
        conn.setConnectTimeout(5000);
        conn.setReadTimeout(10000);
        
        // 限制响应大小
        conn.setRequestProperty("Range", "bytes=0-10240");
        
        return processHttpResponse(conn);
    } catch (Exception e) {
        return "Error: " + e.getMessage();
    }
}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 防护建议 -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-shield-alt"></i> 协议攻击防护建议</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>协议限制：</h6>
                            <ul>
                                <li>严格的协议白名单（仅http/https）</li>
                                <li>禁用file://、ftp://、gopher://等</li>
                                <li>URL解析库安全配置</li>
                                <li>协议处理器禁用</li>
                            </ul>
                            
                            <h6>网络层防护：</h6>
                            <ul>
                                <li>防火墙规则限制</li>
                                <li>网络隔离</li>
                                <li>代理服务器过滤</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>应用层防护：</h6>
                            <ul>
                                <li>输入严格验证</li>
                                <li>响应内容过滤</li>
                                <li>超时和大小限制</li>
                                <li>错误信息脱敏</li>
                            </ul>
                            
                            <h6>监控告警：</h6>
                            <ul>
                                <li>异常协议访问监控</li>
                                <li>内网访问告警</li>
                                <li>敏感文件访问记录</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        let generatedGopherPayload = '';
        
        // 设置协议URL
        function setProtocolUrl(url) {
            document.getElementById('protocolUrl').value = url;
        }
        
        // 执行协议攻击
        function executeProtocolAttack() {
            const url = document.getElementById('protocolUrl').value;
            
            if (!url.trim()) {
                alert('请输入攻击URL');
                return;
            }
            
            const resultDiv = document.getElementById('protocolResult');
            resultDiv.textContent = '执行协议攻击中...';
            
            fetch('/ssrf/protocol', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}`
            })
            .then(response => response.json())
            .then(data => {
                let result = `攻击URL: ${data.url}\n`;
                result += `协议类型: ${data.protocol}\n`;
                result += `执行时间: ${data.executionTime}ms\n`;
                result += `状态: ${data.success ? '成功' : '失败'}\n\n`;
                
                if (data.protocolInfo) {
                    result += `协议信息:\n`;
                    result += `  支持状态: ${data.protocolInfo.supported ? '支持' : '不支持'}\n`;
                    result += `  安全等级: ${data.protocolInfo.securityLevel}\n`;
                    result += `  风险描述: ${data.protocolInfo.riskDescription}\n\n`;
                }
                
                if (data.responseContent) {
                    result += `响应内容:\n${data.responseContent}`;
                }
                
                if (data.error) {
                    result += `错误信息: ${data.error}`;
                }
                
                if (data.warning) {
                    result += `\n警告: ${data.warning}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '攻击失败: ' + error;
            });
        }
        
        // 生成Gopher载荷
        function generateGopherPayload() {
            const host = document.getElementById('gopherHost').value;
            const port = document.getElementById('gopherPort').value;
            const command = document.getElementById('gopherCommand').value;
            const protocol = document.getElementById('gopherProtocol').value;
            
            if (!host || !port || !command) {
                alert('请填写完整信息');
                return;
            }
            
            const resultDiv = document.getElementById('gopherResult');
            resultDiv.textContent = '生成Gopher载荷中...';
            
            fetch('/ssrf/gopher/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `host=${encodeURIComponent(host)}&port=${port}&command=${encodeURIComponent(command)}&protocol=${protocol}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    generatedGopherPayload = data.payload;
                    let result = `原始命令: ${data.originalCommand}\n`;
                    result += `协议类型: ${data.protocolType}\n`;
                    result += `目标地址: ${data.targetHost}:${data.targetPort}\n\n`;
                    result += `编码过程:\n`;
                    result += `1. 原始命令: ${data.originalCommand}\n`;
                    result += `2. 协议格式化: ${data.formattedCommand}\n`;
                    result += `3. URL编码: ${data.encodedCommand}\n\n`;
                    result += `最终载荷:\n${data.payload}`;
                    
                    resultDiv.textContent = result;
                } else {
                    resultDiv.textContent = '生成失败: ' + data.error;
                }
            })
            .catch(error => {
                resultDiv.textContent = '生成失败: ' + error;
            });
        }
        
        // 测试Gopher载荷
        function testGopherPayload() {
            if (!generatedGopherPayload) {
                alert('请先生成Gopher载荷');
                return;
            }
            
            document.getElementById('protocolUrl').value = generatedGopherPayload;
            executeProtocolAttack();
        }
        
        // 复制Gopher载荷
        function copyGopherPayload() {
            if (!generatedGopherPayload) {
                alert('请先生成Gopher载荷');
                return;
            }
            
            navigator.clipboard.writeText(generatedGopherPayload).then(() => {
                alert('载荷已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                // 降级方案
                const textArea = document.createElement('textarea');
                textArea.value = generatedGopherPayload;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('载荷已复制到剪贴板');
            });
        }
        
        // 清除结果
        function clearProtocolResult() {
            document.getElementById('protocolResult').textContent = '选择协议载荷并点击"执行协议攻击"查看结果...';
        }
    </script>
</body>
</html>